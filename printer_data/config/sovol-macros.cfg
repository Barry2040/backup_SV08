#####################################################################
# SOVOL SV08 - Macro Configuration
# Zusammengefasste und aufgeräumte Version
#####################################################################

#####################################################################
# Globale Variablen und Konfiguration
#####################################################################
[gcode_macro _global_var]
description: Zentrale Konfiguration für alle Macros
variable_pause_park: {'x': 0, 'y': 0, 'z': 10, 'e': 1}
variable_cancel_park: {'x': 0, 'y': 350, 'z': 10, 'e': 1}
variable_z_maximum_lifting_distance: 345
variable_pause_resume_travel_speed: 150
variable_bed_mesh_calibrate_target_temp: 60
variable_load_filament_extruder_temp: 230
variable_heat_soak_time: 0                 # in Minuten
gcode:

#####################################################################
# Force Move (für manuelle Bewegungen ohne Homing)
#####################################################################
[force_move]
enable_force_move: True

#####################################################################
# Beleuchtung Steuerung
#####################################################################
[gcode_macro MAINLED_ON]
description: Hauptbeleuchtung einschalten
gcode:
    SET_LED LED=main_led WHITE=1

[gcode_macro MAINLED_OFF]
description: Hauptbeleuchtung ausschalten
gcode:
    SET_LED LED=main_led WHITE=0

#####################################################################
# START_PRINT - Hauptmacro für Druckstart
#####################################################################
[gcode_macro START_PRINT]
description: Optimierte Start Print Macro mit Material-basiertem Heat Soak
variable_state: 'Prepare'
variable_record_extruder_temp: 0
variable_max_record_extruder_temp: 0
gcode:
    # Parameter aus Slicer abrufen
    {% set target_bed = params.BED|int %}
    {% set target_extruder = params.EXTRUDER|int %}
    {% set target_chamber = params.CHAMBER|default("40")|int %}
    {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
    {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}

    # Homing Status prüfen und bei Bedarf homen
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                                    # Vollständiges Homing
    {% elif 'z' not in printer.toolhead.homed_axes %}
        G28 Z                                  # Nur Z homen
    {% endif %}
                
    G90                                        # Absolute Koordinaten
    M400                                       # Auf Bewegungsende warten
    CLEAR_PAUSE                                # Pause-Status löschen
    BED_MESH_CLEAR                             # Altes Bed Mesh löschen

    #-------------------------------------------------------------------#
    # HEAT SOAK LOGIK
    #-------------------------------------------------------------------#
    
    # Hohe Temperaturen (>90°C) - Erweiterte Heat Soak Prozedur
    {% if params.BED|int > 90 %}
        M117 Bed: {target_bed}C
        M106 S255                              # Lüfter für Luftzirkulation
        
        # Nevermore Filter einschalten (falls vorhanden)
        {% if printer["output_pin nevermore"] is defined %}
            SET_PIN PIN=nevermore VALUE=1
        {% endif %}
        
        G1 X{x_wait} Y{y_wait} Z15 F9000       # Zur Bettmitte fahren
        M190 S{target_bed}                     # Bett aufheizen und warten
        
        # Gehäusetemperatur überwachen
        M117 Monitoring chamber: {target_chamber}C
        {% if printer["temperature_sensor chamber"] is defined %}
            TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}
        {% else %}
            M117 Soak: 15min (Kein Gehäusesensor)
            G4 P900000                         # 15 Minuten warten
        {% endif %}

    # Standard Temperaturen - Material-basierte Heat Soak
    {% else %}
        M117 Bed: {target_bed}C
        G1 X{x_wait} Y{y_wait} Z15 F9000       # Zur Bettmitte fahren
        M190 S{target_bed}                     # Bett aufheizen und warten
        
        # Material-Erkennung mit Varianten-Unterstützung
        {% set raw_material = params.MATERIAL|default("PLA")|string|upper %}
        
        # Basis-Material extrahieren
        {% set material = namespace(type="") %}
        {% if "PLA" in raw_material %}
            {% set material.type = "PLA" %}
        {% elif "PETG" in raw_material %}
            {% set material.type = "PETG" %}
        {% elif "TPU" in raw_material or "TPE" in raw_material %}
            {% set material.type = "TPU" %}
        {% elif "PVA" in raw_material %}
            {% set material.type = "PVA" %}
        {% elif "HIPS" in raw_material %}
            {% set material.type = "HIPS" %}
        {% elif "ABS" in raw_material %}
            {% set material.type = "ABS" %}
        {% elif "ASA" in raw_material %}
            {% set material.type = "ASA" %}
        {% elif "NYLON" in raw_material or "PA" in raw_material %}
            {% set material.type = "NYLON" %}
        {% elif "PC" in raw_material and "POLYCARBONATE" in raw_material %}
            {% set material.type = "PC" %}
        {% elif "PP" in raw_material or "POLYPROPYLENE" in raw_material %}
            {% set material.type = "PP" %}
        {% elif "FLEX" in raw_material %}
            {% set material.type = "FLEX" %}
        {% else %}
            {% set material.type = raw_material %}
        {% endif %}

        # Material-spezifische Soak-Zeiten (in Millisekunden)
        {% set soak_time = {
            "PLA": 120000,      # 2 min - Niedrige Temperatur, minimal Soak
            "PETG": 180000,     # 3 min - Mittlere Temperatur, moderater Soak
            "TPU": 120000,      # 2 min - Flexibel, niedrige Temperatur
            "FLEX": 120000,     # 2 min - Flexible Materialien
            "PVA": 120000,      # 2 min - Support Material wie PLA
            "HIPS": 300000,     # 5 min - Support Material, höhere Temperatur
            "ABS": 600000,      # 10 min - Hohe Temperatur, guter Soak nötig
            "ASA": 600000,      # 10 min - Wie ABS, für Außeneinsatz
            "NYLON": 420000,    # 7 min - Hygroskopisch, stabile Temperatur nötig
            "PC": 480000,       # 8 min - Sehr hohe Temperatur, guter Soak
            "PP": 240000,       # 4 min - Niedrige Haftung, moderater Soak
        }[material.type]|default(300000) %}    # Standard: 5 Minuten
        
        M117 Soak: {soak_time/60000|int}min ({raw_material})
        G4 P{soak_time}                        # Soak ausführen
    {% endif %}
    
    #-------------------------------------------------------------------#
    # GANTRY LEVELING
    #-------------------------------------------------------------------#
    
    # Custom GANTRY_LEVELING Macro verwenden (falls vorhanden)
    {% if printer.configfile.config['gcode_macro GANTRY_LEVELING'] is defined %}
        M117 Gantry Leveling...
        GANTRY_LEVELING
    {% else %}
        # Fallback auf Standard-Methoden
        {% if 'z_tilt' in printer %}
            M117 Z-tilt adjust...
            Z_TILT_ADJUST
        {% elif 'quad_gantry_level' in printer %}
            M117 QGL...
            QUAD_GANTRY_LEVEL
        {% endif %}
    {% endif %}
    
    # Z-Achse nach Leveling prüfen und ggf. homen
    {% if 'z' not in printer.toolhead.homed_axes %}
        M117 Z homing...
        G28 Z
    {% endif %}

    #-------------------------------------------------------------------#
    # DÜSE VORBEREITEN
    #-------------------------------------------------------------------#
    
    # Düse auf 150°C vorheizen für korrektes Z-Homing
    M117 Hotend: 150C
    M109 S150

    # Düsenreinigung durchführen
    M117 Cleaning the nozzle...
    CLEAN_NOZZLE

    # Toolhead parken für Bed Mesh
    SMART_PARK

    #-------------------------------------------------------------------#
    # BED MESH KALIBRIERUNG
    #-------------------------------------------------------------------#

    M117 Bed mesh (Full Bed)
    BED_MESH_CALIBRATE_BASE              # Volles Bett ohne KAMP
    # ODER falls du Rapid Scan nutzen willst:
    # BED_MESH_CALIBRATE_BASE METHOD=rapid_scan

    CARTOGRAPHER_TOUCH_HOME
    M400

    #-------------------------------------------------------------------#
    # FINALE AUFHEIZUNG & DRUCK START
    #-------------------------------------------------------------------#
    
    # Düse auf Drucktemperatur aufheizen
    M117 Hotend: {target_extruder}C
    M107                                       # Part Cooling Lüfter aus
    M109 S{target_extruder}                    # Düse aufheizen und warten
    
    # Purge Line (KAMP)
    M117 The purge...
    LINE_PURGE                                 # Adaptive Purge Line

    M117 Printer goes brrr                     # Druck startet
    
#####################################################################
# END_PRINT - Macro für Druckende
#####################################################################
[gcode_macro END_PRINT]
description: 
variable_state: 'normal'
gcode:
    {% set z_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance|int %}
    {% set e_mintemp  = printer.configfile.settings['extruder'].min_extrude_temp %}
    M400
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0  
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0
    M117 Done
    G91
    
    # Filament zurückziehen wenn Extruder heiß genug ist
    {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
          printer.extruder.temperature >= e_mintemp
    %}
        G1 E-2 F2700
        G1 E-2 Z0.2 F2400
    {% endif %}
    
    {% if (printer.gcode_move.position.z + 25) < z_max %}
        G1 Z+25 F3000
    {% else %}
        G1 Z+{(z_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    G90
    G1 X0 Y360 F9000
    _ALL_FAN_OFF
    TURN_OFF_HEATERS
    
    M107    
  
    M84 X Y Z E  
    M220 S100
    M221 S100
    CLEAR_PAUSE
    {action_respond_info("Finish Print!")}

#####################################################################
# PAUSE, RESUME & CANCEL
#####################################################################
[gcode_macro PAUSE]
description: Pausiert den aktuellen Druck
rename_existing: PAUSE_BASE
variable_state: 'normal'
gcode:
    {% if printer.pause_resume.is_paused == False %}
        {% set x_park = printer['gcode_macro _global_var'].pause_park.x|float %}
        {% set y_park = printer['gcode_macro _global_var'].pause_park.y|float %}
        {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
        {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
        {% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}
        
        {action_respond_info("Pause Print!")}
        
        PAUSE_BASE
        M117 Pause Print!!!
        
        # Z-Achse anheben
        G91
        {% if (printer.gcode_move.position.z + 5) < z_lift_max %}
            G1 Z+5 F3000
        {% else %}
            G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
        {% endif %}
        
        # Zur Park Position fahren
        G90
        {% if printer.gcode_move.position.x != x_park and
              printer.gcode_move.position.y != y_park     
        %}
            G1 X{x_park} Y{y_park} F{printer["gcode_macro _global_var"].pause_resume_travel_speed * 60}
        {% endif %}

        M104 S{printer.extruder.target}        # Temperatur halten
    
        # Filament Handling basierend auf State
        {% if state == 'normal' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and 
                  (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                {% if printer['filament_switch_sensor filament_sensor'].enabled == True and 
                      printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
                    G91
                    G1 E-{e_restract} F300     # Filament zurückziehen
                    G90
                {% elif printer['filament_switch_sensor filament_sensor'].enabled == True and 
                        printer['filament_switch_sensor filament_sensor'].filament_detected != True %}
                    # Filament entladen wenn nicht erkannt
                    G91
                    G1 E+95 F300
                    G1 E-10 F1500
                    G1 E-20 F600
                    M400
                    G4 P3000
                    G1 E-50 F300 
                    G90
                {% endif %}
            {% endif %}
        {% elif state == 'filament_change' %}
            {% if (printer.extruder.temperature + 5 >= printer.extruder.target) and 
                  (printer.extruder.temperature >= printer.configfile.settings['extruder'].min_extrude_temp) %}
                # Filament Wechsel Sequenz
                G91
                G1 E+25 F300
                G1 E-10 F1500
                G1 E-20 F600
                M400
                G4 P3000
                G1 E-50 F300 
                G90
            {% endif %}
        {% endif %}
    {% endif %}

[gcode_macro RESUME]
description: Setzt den pausierten Druck fort
rename_existing: RESUME_BASE
variable_state: 'normal'
gcode:
    {% set e_restract = printer['gcode_macro _global_var'].pause_park.e|float %}
    {% set extruder_target_temp = printer.extruder.target|int %}
    {% set state = params.STATE if 'filament_change' in params.STATE else 'normal' %}

    {% if state == 'filament_change' %}
        # Filament Wechsel Resume
        {% if printer["filament_switch_sensor filament_sensor"].enable == True and
              printer["filament_switch_sensor filament_sensor"].filament_detected != True %}
            {action_respond_info("Please Insert filament in Sensor!")}
        {% else %}
            {% if printer.extruder.temperature + 5 >= printer.extruder.target %}
                G91
                G1 E30 F300                    # Filament laden
                G1 E10 F150
                G90
            {% else %}
                M104 S{extruder_target_temp}
                {action_respond_info("Nozzle heating...")}
                M109 S{extruder_target_temp}
                G91
                G1 E30 F300
                G1 E10 F150
                G90
            {% endif %}
            {action_respond_info("Print resumming!")}
            RESUME_BASE
        {% endif %}
    {% elif state == 'normal' %}
        # Normaler Resume
        {% if printer['filament_switch_sensor filament_sensor'].enable != True and
              printer['filament_switch_sensor filament_sensor'].filament_detected != True %}
            {action_respond_info("Please Insert filament in Sensor!")}
        {% else %}
            {action_respond_info("Print resumming!")}
            G91
            G1 E{e_restract} F300              # Filament nachladen
            G90
            M117 Printing now!!!
            RESUME_BASE
        {% endif %}
    {% endif %}

[gcode_macro CANCEL_PRINT]
description: Bricht den aktuellen Druck ab
rename_existing: CANCEL_PRINT_BASE
gcode:
    {% set x_park = printer['gcode_macro _global_var'].cancel_park.x|float %}
    {% set y_park = printer['gcode_macro _global_var'].cancel_park.y|float %}
    {% set z_park = printer['gcode_macro _global_var'].cancel_park.z|float %}
    {% set z_lift_max = printer['gcode_macro _global_var'].z_maximum_lifting_distance %}
    {% set e_restract = printer['gcode_macro _global_var'].cancel_park.e|float %}
    {% set e_mintemp = printer.configfile.settings['extruder'].min_extrude_temp %}

    CANCEL_PRINT_BASE
    M117 Print canceled!
    
    # Filament zurückziehen
    G91
    {% if printer['filament_switch_sensor filament_sensor'].enabled == True and 
          printer['filament_switch_sensor filament_sensor'].filament_detected == True %}
        {% if (printer.extruder.target != 0 and printer.extruder.temperature >= printer.extruder.target) or
              printer.extruder.temperature >= e_mintemp %}
            G1 E-{e_restract} F500
        {% else %}
            {action_respond_info("Nozzle not hot enough")}
        {% endif %}
    {% endif %}

    # Z-Achse hochfahren
    {% if (printer.gcode_move.position.z + 10) < z_lift_max %}
        G1 Z+10 F3000
    {% else %}
        G1 Z+{(z_lift_max - printer.gcode_move.position.z)} F3000
    {% endif %}
    
    # Zur Park Position fahren
    G90
    G1 X{x_park} Y{y_park} F9000

    # Alles ausschalten
    TURN_OFF_HEATERS
    _ALL_FAN_OFF
    CLEAR_PAUSE
    M84 X Y Z E

    M117 Ready
    {action_respond_info("Cancel Print Success!")}
    
    # START_PRINT Variablen zurücksetzen
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=state VALUE='"Prepare"'
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=record_extruder_temp VALUE=0  
    SET_GCODE_VARIABLE MACRO=START_PRINT VARIABLE=max_record_extruder_temp VALUE=0

#####################################################################
# FILAMENT HANDLING
#####################################################################
[gcode_macro LOAD_FILAMENT]
description: Lädt Filament in den Extruder
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        # Düse aufheizen wenn nötig
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        
        # Filament laden
        M117 Extruding...
        G91 
        G1 E75 F300                            # Hauptladung
        G1 E30 F150                            # Langsamere Nachladung
        G1 E-2 F300                            # Kleiner Retract
        G90
        M400
        M117 Filament loaded.
        
        # Heizung ausschalten wenn nicht pausiert
        {% if current_target_temp == 0 or printer.print_stats.state != "paused" %}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't load filament during printing!!!")}
    {% endif %}

[gcode_macro UNLOAD_FILAMENT]
description: Entlädt Filament aus dem Extruder
gcode:
    {% set extruder_temp = printer['gcode_macro _global_var'].load_filament_extruder_temp|int %}
    {% set current_target_temp = printer.extruder.target|int %}

    {% if printer.print_stats.state != "printing" %}
        # Düse aufheizen wenn nötig
        {% if printer.print_stats.state != "paused" %}
            M104 S{extruder_temp}
            M117 Nozzle heating...
            M109 S{extruder_temp}
        {% else %}
            {% if printer.extruder.target == 0 %}
                M104 S{extruder_temp}
                M117 Nozzle heating...
                M109 S{extruder_temp}
            {% else %}
                M104 S{printer.extruder.target}
                M117 Nozzle heating...
                M109 S{printer.extruder.target}
            {% endif %}
        {% endif %}
        
        # Filament entladen
        M117 Retracting...
        G91
        G1 E+25 F300                           # Kurz vorwärts
        G1 E-10 F1500                          # Schneller Retract
        G1 E-20 F600                           # Mittlerer Retract
        M400
        G4 P3000                               # 3 Sekunden warten
        G1 E-50 F300                           # Langsamer finaler Retract
        G90
        M400
        M117 Filament ejected.
        
        # Heizung ausschalten wenn nicht pausiert
        {% if current_target_temp == 0 or printer.print_stats.state != "paused" %}
            M104 S0
        {% endif %}
    {% else %}
        {action_respond_info("Don't unload filament during printing!!!")}
    {% endif %}

[gcode_macro M600]
description: Filament-Wechsel Macro (Standard M600 Code)
gcode:
    PAUSE STATE=filament_change

#####################################################################
# DÜSENREINIGUNG
#####################################################################
[gcode_macro CLEAN_NOZZLE]
description: Reinigt die Düse mit konfigurierbarer Temperatur und Wischmuster
gcode:
    SAVE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE
    
    # Reinigungstemperatur ermitteln
    {% set NOZZLE_TEMP = params.EXTRUDER|default(params.TEMP|default(150))|int %}
    {% set wipes = params.WIPES|default(5)|int %}
    
    # Homing Status prüfen
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                                    # Vollständiges Homing
    {% elif 'z' not in printer.toolhead.homed_axes %}
        G28 Z                                  # Nur Z homen
    {% endif %}
    
    # Leveling nur wenn noch nicht angewendet
    {% if ('z_tilt' in printer and not printer.z_tilt.applied) or 
          ('quad_gantry_level' in printer and not printer.quad_gantry_level.applied) %}
        
        {% if printer.configfile.config['gcode_macro GANTRY_LEVELING'] is defined %}
            M117 Gantry Leveling...
            GANTRY_LEVELING
        {% else %}
            {% if 'z_tilt' in printer and not printer.z_tilt.applied %}
                M117 Z-tilt...
                Z_TILT_ADJUST
            {% elif 'quad_gantry_level' in printer and not printer.quad_gantry_level.applied %}
                M117 QGL...
                QUAD_GANTRY_LEVEL
            {% endif %}
        {% endif %}
    {% else %}
        M117 Leveling already applied - skipping
        {action_respond_info("Gantry leveling skipped - already applied")}
    {% endif %}
    
    # Z-Achse nach Leveling prüfen
    {% if 'z' not in printer.toolhead.homed_axes %}
        M117 Z homing
        G28 Z
    {% endif %}
    
    # Zur Reinigungsposition fahren
    G90
    G1 X324 Y357 Z10 F7800
    
    # Düse aufheizen
    M117 Heating nozzle...
    {action_respond_info("Heating nozzle to %s°C" % (NOZZLE_TEMP))}
    M109 S{NOZZLE_TEMP}
    
    # Reinigung starten
    M106 S127                                  # Lüfter auf 50%
    M117 Cleaning nozzle
    
    G1 X324 Y357 F7800                         # Startposition
    G1 Z0.2 F300                               # Auf Reinigungshöhe absenken
    
    # Reinigungssequenz
    {% for wipe in range(wipes) %}
        # Gerade Wischbewegungen (X-Achse)
        G1 X352 Y357 F7800                     # Wischen nach rechts
        G1 X324 Y357 F7800                     # Wischen nach links
        
        # Zickzack-Muster
        G1 Y362 X332 F7800                     # Diagonal vorwärts
        G1 Y360 X336 F7800                     # Mittelpunkt
        G1 Y357 X352 F7800                     # Diagonal zurück
        
        # Konstanter Druck Reinigung
        G1 Y362 X324 F7800                     # Vorwärts wischen
        G1 Y357 X332 F7800                     # Rückwärts wischen
    {% endfor %}
    
    # Abschluss
    G1 Y363 X324 F7800                         # Vom Reinigungsbereich wegfahren
    M400
    M117 Clean Complete
    M107                                       # Lüfter aus
    
    # Zurück zu sicherer Position
    G91
    G1 Z10 F300                                # Düse anheben
    G90
    G28 Z                                      # Z homen
    
    # Heizungen nur ausschalten wenn Idle
    {% if printer.idle_timeout.state == "Idle" %}
        TURN_OFF_HEATERS
        {action_respond_info("Cleaning complete - heaters turned off (idle state)")}
    {% else %}
        {action_respond_info("Cleaning complete - heaters maintained (printing state)")}
    {% endif %}
    
    RESTORE_GCODE_STATE NAME=CLEAN_NOZZLE_STATE

#####################################################################
# KALIBRIERUNG & LEVELING MACROS
#####################################################################
[gcode_macro G34]
description: Komplette Nivellierung und Homing
gcode:
    BED_MESH_CLEAR 
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G28
    {% else %}
        G28 Z
    {% endif %}
    QUAD_GANTRY_LEVEL 
    G28 Z 
    G0 X175 Y175 Z30 F3600

[gcode_macro _CALIBRATION_ZOFFSET]
description: Z-Offset Kalibrierung durchführen
gcode:
    M117 Calibrate Offset
    QUAD_GANTRY_LEVEL
    M140 S65
    G4 P500
    CLEAN_NOZZLE
    G4 P500
    M117 Z-offset calibration
    Z_OFFSET_CALIBRATION
    Z_OFFSET_APPLY_PROBE
    M400
    G4 P3000
    SAVE_CONFIG

#####################################################################
# QUAD GANTRY LEVEL - Überschreibung mit Heizungs-Check
#####################################################################
[gcode_macro QUAD_GANTRY_LEVEL]
description: QGL mit automatischer Bett-Aufheizung
rename_existing: QUAD_GANTRY_LEVEL_BASE
gcode:
    {% set mesh_name = "default" %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
    {% set current_target_temp = printer.heater_bed.target|int %}

    {action_respond_info("Check Heating!")}
    
    # Bett aufheizen wenn nötig
    {% if printer.heater_bed.temperature != mesh_calibrate_temp %}
        {action_respond_info("The bed target temperature was not reached!")}
        {action_respond_info("Bed heating...")}
        {% if current_target_temp <= mesh_calibrate_temp %}
            M190 S{mesh_calibrate_temp}
        {% else %}
            M190 S{current_target_temp}
        {% endif %}
    {% endif %}

    # Homing prüfen
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G28
    {% endif %}

    QUAD_GANTRY_LEVEL_BASE

    # Heizung ausschalten wenn ursprünglich aus
    {% if current_target_temp == 0 %}
        M140 S0
    {% endif %}

#####################################################################
# BED MESH CALIBRATE - Überschreibung mit Heizungs-Check
#####################################################################
[gcode_macro BED_MESH_CALIBRATE]
description: Bed Mesh mit automatischer Bett-Aufheizung
rename_existing: BED_MESH_CALIBRATE_BASE
gcode:
    {% set mesh_name = "default" %}
    {% set mesh_calibrate_temp = printer['gcode_macro _global_var'].bed_mesh_calibrate_target_temp|int %}
    {% set current_target_temp = printer.heater_bed.target|int %}

    {action_respond_info("Check Heating!")}
    
    # Bett aufheizen wenn nötig
    {% if printer.heater_bed.temperature != mesh_calibrate_temp %}
        {action_respond_info("The bed target temperature was not reached!")}
        {action_respond_info("Bed heating...")}
        {% if current_target_temp <= mesh_calibrate_temp %}
            M190 S{mesh_calibrate_temp}
        {% else %}
            M190 S{current_target_temp}
        {% endif %}
    {% endif %}

    # Homing prüfen
    {% if printer.toolhead.homed_axes|lower != "xyz" %}
        G28
    {% endif %}

    BED_MESH_CLEAR
    BED_MESH_CALIBRATE_BASE ADAPTIVE=1         # Adaptive Bed Mesh

    # Heizung ausschalten wenn ursprünglich aus
    {% if current_target_temp == 0 %}
        M140 S0  
    {% endif %}

#####################################################################
# TEMPERATUR WAIT - M109 und M190 Überschreibungen
#####################################################################
[gcode_macro M109]
description: Extruder aufheizen und warten (mit Toleranz)
rename_existing: M99109
gcode:    
    {% set s = params.S|float %}    
    M104 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={s-1} MAXIMUM={s+1}
    {% endif %}
    
[gcode_macro M190]
description: Bett aufheizen und warten (mit Toleranz)
rename_existing: M99190
gcode:    
    {% set s = params.S|float %}
    M140 {% for p in params %}{'%s%s' % (p, params[p])}{% endfor %}
    {% if s != 0 %}
        TEMPERATURE_WAIT SENSOR=heater_bed MINIMUM={s-1} MAXIMUM={s+1}
    {% endif %}

#####################################################################
# UTILITY MACROS
#####################################################################
[gcode_macro CENTER]
description: Fährt die Düse zur Bettmitte
gcode:
    G0 X175 Y175 F5000

[gcode_macro _ALL_FAN_OFF]
description: Schaltet alle Lüfter aus
gcode:
    M106 S0                                    # Part Cooling Fan aus
    M107                                       # Part Cooling Fan aus (Backup)
    # Exhaust Fan mit Verzögerung ausschalten (optional)
    # UPDATE_DELAYED_GCODE ID=exhaust_fan_off DURATION=120

[gcode_macro _IDLE_TIMEOUT]
description: Wird bei Idle Timeout ausgeführt
gcode:
    {% if printer.print_stats.state == "paused" %}
        RESPOND TYPE=echo MSG="No operations in 10min!"
    {% else %}
        M84                                    # Motoren deaktivieren
        TURN_OFF_HEATERS                       # Heizungen ausschalten
    {% endif %}

#####################################################################
# DELAYED GCODE MACROS
#####################################################################
[delayed_gcode bed_mesh_init]
initial_duration: .01
gcode:
    BED_MESH_PROFILE LOAD=default

[delayed_gcode _auto_zoffset]
gcode:
    SAVE_VARIABLE VARIABLE=offsetadjust VALUE={'%05.2f' % (0)}
    _CALIBRATION_ZOFFSET

[delayed_gcode _print_start_wait]
gcode:
    {% if printer['gcode_macro START_PRINT'].state == 'Heating'%}
        {action_respond_info("Prepare->Heating!")}
    {% elif printer['gcode_macro START_PRINT'].state == 'Start' %}
        {action_respond_info("Heating->Start!")}
    {% endif %}

    {% if printer['gcode_macro START_PRINT'].execute|lower != 'false' %}
        START_PRINT
    {% endif %}

[delayed_gcode exhaust_fan_off]
gcode:
    SET_FAN_SPEED FAN=exhaust_fan SPEED=0

[delayed_gcode TEST_BELT]
initial_duration: 0.3
gcode:
    {% set x_freq = printer.save_variables.variables.x_freq|float %}
    {% set y_freq = printer.save_variables.variables.y_freq|float %}
    {% set show_freq = printer.save_variables.variables.show_freq %}
    {% if show_freq == 1 %}
        M117 x {x_freq}, y {y_freq}
        SAVE_VARIABLE VARIABLE=show_freq VALUE=0
    {% endif %}